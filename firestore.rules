/**
 * @fileoverview Firestore Security Rules for the error reporting system.
 *
 * Core Philosophy:
 * This ruleset allows any authenticated user (including anonymous) to create, read, and list error reports within a specific application.
 *
 * Data Structure:
 * Error reports are stored in the `/artifacts/{appId}/public/data/error_reports/{errorReportId}` collection.
 *
 * Key Security Decisions:
 * - Any authenticated user can create error reports.
 * - Any authenticated user can read error reports.
 * - All reports are stored under a common path to allow secure list operations and simplified security rules.
 *
 * Denormalization for Authorization:
 *  - Not required. All authenticated users can create error reports.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows any authenticated user to create, read, update, and delete error reports.
     * @path /artifacts/{appId}/public/data/error_reports/{errorReportId}
     * @allow (create) - Any authenticated user can create an error report.
     *          Example: request.auth.uid != null
     * @allow (get) - Any authenticated user can read an error report.
     *          Example: request.auth.uid != null
     * @allow (list) - Any authenticated user can list error reports.
     *          Example: request.auth.uid != null
     * @allow (update) - Only the user who created the report can update it.
     *          Example: request.auth.uid != null
     * @allow (delete) - Only the user who created the report can delete it.
     *          Example: request.auth.uid != null
     * @deny (create) - An unauthenticated user cannot create an error report.
     *          Example: request.auth.uid == null
     * @deny (update) - Updating a non-existent document.
     *          Example: resource == null
     * @deny (delete) - Deleting a non-existent document.
     *          Example: resource == null
     * @principle Allows any authenticated user to perform operations on error reports.
     */
    match /artifacts/{appId}/public/data/error_reports/{errorReportId} {
      // Allow anyone to read error reports
      allow get: if isSignedIn();
      allow list: if isSignedIn();

      // Allow authenticated users to create error reports
      allow create: if isSignedIn() && request.resource.data.reportedByUserId == request.auth.uid && request.resource.data.id == errorReportId;

      // Allow authenticated users to update error reports
      allow update: if isSignedIn() && resource.data.reportedByUserId == request.auth.uid && resource != null && request.resource.data.id == resource.data.id;

      // Allow authenticated users to delete error reports
      allow delete: if isSignedIn() && resource.data.reportedByUserId == request.auth.uid && resource != null;
    }
  }

  function isSignedIn() {
    return request.auth != null;
  }

}